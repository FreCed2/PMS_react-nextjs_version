<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Overview for {{ project_name }}</title>
    <style>
        .missing { background-color: #ffe6e6; }
        .expandable { cursor: pointer; }
        .disabled { color: grey; cursor: not-allowed; }
        .hidden { display: none; }
        .details-row { padding-left: 20px; }
        .contributor-info { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Progress Overview for {{ project_name }}</h1>

    <!-- Old Add Contributor Form for conributors stored in specific project -->
    <!--<h2>Add Contributor</h2>
    <form id="add-contributor-form" data-project-name="{{ project_name }}">
        {{ add_contributor_form.hidden_tag() }}
        <label for="contributor_name">Contributor Name:</label>
        {{ add_contributor_form.contributor_name() }}<br>
        <button type="button" id="add-contributor-button">Add Contributor</button>
    </form>-->

    <!-- New form for globally stored contributors -->
    <form id="add-contributor-form" data-project-name="{{ project_name }}">
    {{ add_contributor_form.hidden_tag() }}
    <label for="contributor_name">Contributor Name:</label>
    <select name="contributor_name" id="existing-contributors">
        <option value="">Select Existing Contributor</option>
        {% for contributor in all_contributors %}
            <option value="{{ contributor.name }}">{{ contributor.name }}</option>
        {% endfor %}
    </select>
    <input type="text" name="contributor_name" placeholder="Or add a new contributor">
    <button type="button" id="add-contributor-button">Add Contributor</button>
</form>

    <!-- Progress Overview Table -->
<table border="1" id="progress-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Total Story Points</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for date_info in dates_info %}
        <tr class="{{ 'missing' if date_info.missing else '' }} {{ 'disabled' if date_info.future else '' }}"
            id="date-row-{{ date_info.date }}">
            <td>{{ date_info.date }}</td>
            <td>{{ date_info.points }}</td>
            <td>
                {% if not date_info.future %}
                <button type="button" onclick="toggleDetails('{{ date_info.date }}')">View/Edit Details</button>
                {% else %}
                <span>Future Date - Editing Disabled</span>
                {% endif %}
            </td>
        </tr>
        <tr id="details-{{ date_info.date }}" class="hidden details-row">
            <td colspan="3">
                <form method="POST" id="progress-form-{{ date_info.date }}" data-project-name="{{ project_name }}">
                    {{ progress_edit_form.hidden_tag() }}
                    {% if date_info.contributors %}
                        {% for contributor in date_info.contributors %}
                            <div class="contributor-info">
                                <input type="hidden" name="contributor_name" value="{{ contributor.contributor }}">
                                <h4>Editing Progress for {{ contributor.contributor }}</h4>
                                <label for="contributor_points_{{ contributor.contributor | replace(' ', '_') }}">Story Points:</label>
                                <input type="number" id="contributor_points_{{ contributor.contributor | replace(' ', '_') }}" name="contributor_points" value="{{ contributor.points }}" required><br>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>No contributors assigned for this date. Please add contributors first.</p>
                    {% endif %}
                    <button type="button" onclick="saveContributorProgress('{{ date_info.date }}')">Save Changes</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Function to toggle the visibility of the details row
        function toggleDetails(date) {
            const detailsRow = document.getElementById(`details-${date}`);
            if (detailsRow.classList.contains('hidden')) {
                detailsRow.classList.remove('hidden');
                detailsRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                detailsRow.classList.add('hidden');
            }
        }

        // Adding CSRF token to AJAX requests
        const csrfToken = "{{ csrf_token() }}";

        // Function to add a contributor via AJAX
        $('#add-contributor-button').click(function () {
            const form = $('#add-contributor-form');
            const formData = new FormData(form[0]);
            formData.append('csrf_token', csrfToken);

            const projectName = form.data('project-name');

            $.ajax({
                url: `/add_contributor/${encodeURIComponent(projectName)}`,
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if (response.success) {
                        alert("Contributor added successfully!");
                        location.reload(); // Reload the page to reflect the changes
                    } else {
                        alert("Error adding contributor: " + response.error);
                    }
                },
                error: function (xhr) {
                    alert("An error occurred: " + xhr.responseText);
                }
            });
        });

        // Function to save contributor progress via AJAX
        function saveContributorProgress(date) {
            const form = $(`#progress-form-${date}`);
            const formData = new FormData(form[0]);
            formData.append('csrf_token', csrfToken);

            const projectName = form.data('project-name');

            $.ajax({
                url: `/edit_progress/${encodeURIComponent(projectName)}/${encodeURIComponent(date)}`,
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if (response.success) {
                        alert("Progress saved successfully!");
                        location.reload();
                    } else {
                        alert("Error saving progress: " + response.error);
                    }
                },
                error: function (xhr) {
                    alert("An error occurred: " + xhr.responseText);
                }
            });
        }

        // Automatically expand the first "missing" date row for user convenience
        $(document).ready(function () {
            const firstMissingRow = $('.missing').first();
            if (firstMissingRow.length > 0) {
                const date = firstMissingRow.attr('id').replace('date-row-', '');
                toggleDetails(date);
            }
        });
    </script>
</body>
</html>
